<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimization | Energy Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/optimization.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="main-container">
        <aside class="sidebar">
            <h1>Analysis Pipeline</h1>
            <nav>
                <ul>
                    <li><a href="/">Upload Data</a></li>
                    <li><a href="/clean">Clean & Preprocess</a></li>
                    <li><a href="/fluctuations">Fluctuation Analysis</a></li>
                    <li><a href="/features">Feature Engineering</a></li>
                    <li><a href="/selection">Feature Selection</a></li>
                    <li><a href="/models">Baseline Models</a></li>
                    <li><a href="/deep_learning">Deep Learning</a></li>
                    <li class="active"><a href="/optimization">Optimization</a></li>
                    <li><a href="/anomalies">Anomaly Detection</a></li>
                    <li><a href="/wastage">Wastage Analysis</a></li>
                    <li><a href="/comparison">Final Report</a></li>
                    <li><a href="/deployment">Deployment</a></li>
                    <li><a href="/user_guide">User Guide</a></li>
                </ul>
            </nav>
        </aside>
        <main class="content-panel">
            <header>
                <h2>Hyperparameter Optimization</h2>
                <p>Fine-tuning models to maximize performance and find the best overall solution.</p>
            </header>
            
            <div class="action-card">
                <p>Click to run a simulated optimization process on the XGBoost and Hybrid models.</p>
                <button id="optimize-btn" class="action-btn">
                    Run Optimization
                    <div class="spinner"></div>
                </button>
            </div>

            <div id="results-section" class="hidden">
                <section class="highlight-card">
                    <h3>Best Overall Model</h3>
                    <p id="winner-text"></p>
                </section>
                
                <section class="results-table-container">
                    <h3>Performance Comparison</h3>
                    <table id="comparison-table">
                        <thead>
                            <tr><th>Model</th><th>Version</th><th>MAE</th><th>RMSE</th><th>R²</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>

                <section class="chart-container">
                    <h3>Metric Improvement (MAE)</h3>
                    <div class="canvas-wrapper">
                        <canvas id="improvementChart"></canvas>
                    </div>
                </section>

                <div class="action-card final-step">
                    <p>Optimization is complete. You can now use the best model to find anomalies.</p>
                    <a href="/anomalies" class="action-btn">Proceed to Anomaly Detection &rarr;</a>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const optimizeBtn = document.getElementById('optimize-btn');
        const resultsSection = document.getElementById('results-section');
        let improvementChart;

        optimizeBtn.addEventListener('click', async () => {
            setLoading(true);
            resultsSection.classList.add('hidden');
            try {
                const response = await fetch('/run_optimization', { method: 'POST' });
                const result = await response.json();
                if (!response.ok || result.error) { throw new Error(result.error); }
                displayResults(result);
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                setLoading(false);
            }
        });

        function displayResults(data) {
            document.getElementById('winner-text').textContent = data.best_model_summary;
            populateTable(data.metrics);
            createImprovementChart(data.metrics);
            resultsSection.classList.remove('hidden');
        }

        function populateTable(metrics) {
            const tbody = document.getElementById('comparison-table').querySelector('tbody');
            tbody.innerHTML = '';
            const models = ['XGBoost_Baseline', 'XGBoost_Optimized', 'Hybrid_Baseline', 'Hybrid_Optimized'];
            models.forEach(modelKey => {
                if (metrics[modelKey]) {
                    const modelData = metrics[modelKey];
                    const [modelName, version] = modelKey.split('_');
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${modelName}</td>
                        <td><span class="version-tag ${version.toLowerCase()}">${version}</span></td>
                        <td>${modelData.MAE}</td>
                        <td>${modelData.RMSE}</td>
                        <td>${modelData['R²']}</td>
                    `;
                }
            });
        }

        function createImprovementChart(metrics) {
            const ctx = document.getElementById('improvementChart').getContext('2d');
            if (improvementChart) improvementChart.destroy();
            improvementChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['XGBoost', 'Hybrid'],
                    datasets: [
                        { label: 'Baseline MAE', data: [metrics.XGBoost_Baseline.MAE, metrics.Hybrid_Baseline.MAE], backgroundColor: 'rgba(255, 99, 132, 0.7)' },
                        { label: 'Optimized MAE', data: [metrics.XGBoost_Optimized.MAE, metrics.Hybrid_Optimized.MAE], backgroundColor: 'rgba(50, 205, 50, 0.7)' }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: false, 
                            title: {display: true, text: 'Mean Absolute Error (Lower is Better)', color: '#E0E0E0'} 
                        } 
                    },
                    plugins: {
                        legend: { labels: { color: '#E0E0E0' } }
                    }
                }
            });
        }

        function setLoading(isLoading) {
            optimizeBtn.classList.toggle('loading', isLoading);
            optimizeBtn.disabled = isLoading;
        }
    });
    </script>
</body>
</html>