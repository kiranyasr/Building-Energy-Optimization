<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Report | Energy Analysis</title>

    <!-- External Styling -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/comparison.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h1>Analysis Pipeline</h1>
            <nav>
                <ul>
                    <li><a href="/">Upload Data</a></li>
                    <li><a href="/clean">Clean & Preprocess</a></li>
                    <li><a href="/fluctuations">Fluctuation Analysis</a></li>
                    <li><a href="/features">Feature Engineering</a></li>
                    <li><a href="/selection">Feature Selection</a></li>
                    <li><a href="/models">Baseline Models</a></li>
                    <li><a href="/deep_learning">Deep Learning</a></li>
                    <li><a href="/optimization">Optimization</a></li>
                    <li><a href="/anomalies">Anomaly Detection</a></li>
                    <li><a href="/wastage">Wastage Analysis</a></li>
                    <li class="active"><a href="/comparison">Final Report</a></li>
                    <li><a href="/deployment">Deployment</a></li>
                    <li><a href="/user_guide">User Guide</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Panel -->
        <main class="content-panel">
            <header>
                <h2>Final Results Comparison & Reporting</h2>
                <p>Compare all trained models, visualize performance, and download key results.</p>
            </header>

            <!-- Generate Button -->
            <div class="action-card">
                <p>Click below to compile all results and generate the final report.</p>
                <button id="compile-btn" class="action-btn">
                    Generate Final Report
                    <div class="spinner"></div>
                </button>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden">
                <section class="results-table-container">
                    <h3>Combined Model Summary</h3>
                    <table id="summary-table">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>MAE</th>
                                <th>RMSE</th>
                                <th>R²</th>
                                <th>Model Size (KB)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>

                <div class="grid-container">
                    <section class="chart-container">
                        <h3>Model Accuracy (R²)</h3>
                        <div class="canvas-wrapper"><canvas id="r2Chart"></canvas></div>
                    </section>

                    <section class="chart-container">
                        <h3>Top 10 Feature Importances (Final Model)</h3>
                        <div class="canvas-wrapper"><canvas id="importanceChart"></canvas></div>
                    </section>
                </div>

                <!-- ✅ Single styled Download Button -->
                <section class="artifacts-container">
                    <h3>Downloadable Artifacts</h3>
                    <a href="/download/comparison_summary.xlsx" class="action-btn" style="display:inline-block; margin-top:10px;">
                        Download Comparison Summary Excel
                    </a>
                </section>

                <!-- Next Step -->
                <section class="next-step">
                    <p>The analysis pipeline is complete. You can now proceed to the deployment page to make live predictions.</p>
                    <a href="/deployment" class="action-btn">Go to Deployment →</a>
                </section>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const compileBtn = document.getElementById('compile-btn');
        const resultsSection = document.getElementById('results-section');
        const nextStepSection = document.querySelector('.next-step');
        let r2ChartInstance, importanceChartInstance;

        compileBtn.addEventListener('click', async () => {
            setLoading(true);
            resultsSection.classList.add('hidden');
            if (nextStepSection) nextStepSection.style.display = 'none';

            try {
                const response = await fetch('/get_comparison_data', { method: 'POST' });
                const data = await response.json();

                if (!response.ok || data.error) throw new Error(data.error || 'Unexpected response');

                displayResults(data);
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                setLoading(false);
            }
        });

        function displayResults(data) {
            if (!data || !data.summary_table || !data.charts) {
                alert('Invalid data structure received from backend.');
                return;
            }
            populateTable(data.summary_table || []);
            createR2Chart(data.charts.accuracy_comparison || {});
            createImportanceChart(data.charts.feature_importance || {});
            resultsSection.classList.remove('hidden');
            if (nextStepSection) nextStepSection.style.display = 'block';
        }

        function populateTable(tableData = []) {
            const tbody = document.querySelector('#summary-table tbody');
            tbody.innerHTML = '';
            if (!Array.isArray(tableData)) return;
            tableData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.Model || '-'}</td>
                    <td>${row.MAE || '-'}</td>
                    <td>${row.RMSE || '-'}</td>
                    <td>${row['R²'] || '-'}</td>
                    <td>${row['Model Size (KB)'] || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function createR2Chart(chartData = {}) {
            const ctx = document.getElementById('r2Chart').getContext('2d');
            if (r2ChartInstance) r2ChartInstance.destroy();
            r2ChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels || [],
                    datasets: [{
                        label: 'R² Score (Higher is Better)',
                        data: chartData.r2_data || [],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function createImportanceChart(chartData = {}) {
            const ctx = document.getElementById('importanceChart').getContext('2d');
            if (importanceChartInstance) importanceChartInstance.destroy();
            importanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.features || [],
                    datasets: [{
                        label: 'Importance Score',
                        data: chartData.scores || [],
                        backgroundColor: '#9C27B0'
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
            });
        }

        function setLoading(isLoading) {
            compileBtn.classList.toggle('loading', isLoading);
            compileBtn.disabled = isLoading;
        }
    });
    </script>
</body>
</html>
