<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimization | Energy Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/optimization.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="main-container">
        <aside class="sidebar">
            <h1>Analysis Pipeline</h1>
            <nav>
                <ul>
                    <li><a href="/">1. Upload Data</a></li>
                    <li><a href="/clean">2. Clean & Preprocess</a></li>
                    <li><a href="/fluctuations">3. Fluctuation Analysis</a></li>
                    <li><a href="/features">4. Feature Engineering</a></li>
                    <li><a href="/selection">5. Feature Selection</a></li>
                    <li><a href="/models">6. Baseline Models</a></li>
                    <li><a href="/deep_learning">7. Deep Learning</a></li>
                    <li class="active"><a href="/optimization">8. Optimization</a></li>
                    <li><a href="/anomalies">9. Anomaly Detection</a></li>
                </ul>
            </nav>
        </aside>
        <main class="content-panel">
            <header>
                <h2>Hyperparameter Optimization</h2>
                <p>Simulating optimization to fine-tune the best model (XGBoost) for maximum performance.</p>
            </header>
            
            <div class="action-card">
                <p>Click to run a simulated hyperparameter tuning process. This will train a new model with 'optimized' parameters and compare it to the baseline.</p>
                <button id="optimize-btn" class="action-btn">
                    Run Optimization
                    <div class="spinner"></div>
                </button>
            </div>

            <div id="results-section" class="hidden">
                <section class="results-table-container">
                    <h3>Optimization Results: XGBoost</h3>
                    <table id="comparison-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Baseline Model</th>
                                <th>Optimized Model</th>
                                <th>Improvement</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>
                
                <section class="chart-container">
                    <h3>Metric Improvement Comparison</h3>
                    <div class="canvas-wrapper">
                        <canvas id="improvementChart"></canvas>
                    </div>
                </section>

                <div class="action-card final-step">
                    <p>The optimized model shows significant improvement. You can now proceed to the final step of the analysis.</p>
                    <a href="/anomalies" class="action-btn">Proceed to Anomaly Detection &rarr;</a>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const optimizeBtn = document.getElementById('optimize-btn');
        const resultsSection = document.getElementById('results-section');
        let improvementChart;

        optimizeBtn.addEventListener('click', async () => {
            setLoading(true);
            resultsSection.classList.add('hidden');

            try {
                const response = await fetch('/run_optimization', { method: 'POST' });
                const result = await response.json();

                if (!response.ok || result.error) { throw new Error(result.error); }
                
                displayResults(result);

            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                setLoading(false);
            }
        });

        function displayResults(data) {
            populateTable(data);
            createImprovementChart(data);
            resultsSection.classList.remove('hidden');
        }

        function populateTable(data) {
            const tbody = document.getElementById('comparison-table').querySelector('tbody');
            tbody.innerHTML = '';
            
            for(const metric of ['MAE', 'RMSE', 'R²']) {
                const row = tbody.insertRow();
                const improvement = data.improvement_percent[metric];
                const isGood = (metric === 'R²' && improvement > 0) || (metric !== 'R²' && improvement > 0);
                const colorClass = isGood ? 'good' : 'bad';
                const arrow = isGood ? '▲' : '▼';

                row.innerHTML = `
                    <td>${metric}</td>
                    <td>${data.before[metric]}</td>
                    <td>${data.after[metric]}</td>
                    <td class="${colorClass}">${arrow} ${Math.abs(improvement)}%</td>
                `;
            }
        }

        function createImprovementChart(data) {
            const ctx = document.getElementById('improvementChart').getContext('2d');
            if(improvementChart) {
                improvementChart.destroy();
            }
            improvementChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['MAE', 'RMSE', 'R²'],
                    datasets: [
                        {
                            label: 'Baseline Model',
                            data: [data.before.MAE, data.before.RMSE, data.before['R²']],
                            backgroundColor: 'rgba(255, 99, 132, 0.7)', // Red
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Optimized Model',
                            data: [data.after.MAE, data.after.RMSE, data.after['R²']],
                            backgroundColor: 'rgba(50, 205, 50, 0.7)', // Green
                            borderColor: 'rgba(50, 205, 50, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#bbb' },
                            grid: { color: '#444' }
                        },
                        x: {
                            ticks: { color: '#bbb' },
                            grid: { color: '#444' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E0E0E0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(3);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function setLoading(isLoading) {
            optimizeBtn.classList.toggle('loading', isLoading);
            optimizeBtn.disabled = isLoading;
        }
    });
    </script>
</body>
</html>